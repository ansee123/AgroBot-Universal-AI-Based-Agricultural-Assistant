{% extends "base.html" %}

{% block title %}Weather Forecast - AI-AgroBot{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Chart.js (will be loaded in JS, but can also be here) -->
<style>
.weather-card {
    border-radius: 20px;
    overflow: hidden;
    transition: transform 0.3s ease;
}
.weather-card:hover {
    transform: translateY(-5px);
}
.weather-icon {
    font-size: 3rem;
    filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.1));
}
.forecast-card {
    border: none;
    border-radius: 15px;
    transition: all 0.3s ease;
}
.forecast-card:hover {
    background-color: #f8f9fa;
}
.rain-progress {
    height: 8px;
    border-radius: 4px;
}
.alert-badge {
    position: absolute;
    top: 10px;
    right: 10px;
}
.temperature-gauge {
    height: 150px;
    position: relative;
}
#weatherMap {
    height: 400px;
    border-radius: 10px;
    z-index: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 position-relative">
    <!-- Loading Spinner -->
    <div id="weatherSpinner" class="spinner-border text-success position-absolute top-0 end-0 m-3" style="display: none; z-index: 1000;"></div>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-info text-black weather-card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="display-5 fw-bold mb-3">Weather Forecast</h1>
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-geo-alt-fill me-2"></i>
                                <h4 class="mb-0" id="cityName">{{ current_user.region or 'Your Region' }}</h4>
                                <button class="btn btn-sm btn-light ms-3" id="changeLocation">
                                    <i class="bi bi-pencil"></i> Change
                                </button>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="me-4">
                                    <div class="display-3 fw-bold" id="currentTemp">28°C</div>
                                    <small id="feelsLike">Feels like 30°C</small>
                                </div>
                                <div>
                                    <i class="bi bi-cloud-sun-fill weather-icon" id="weatherIcon"></i>
                                    <div id="weatherDesc">Partly Cloudy</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="mb-2">
                                        <i class="bi bi-droplet-fill fs-4"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold" id="humidityVal">65%</div>
                                        <small>Humidity</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="mb-2">
                                        <i class="bi bi-wind fs-4"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold" id="windVal">12 km/h</div>
                                        <small>Wind</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="mb-2">
                                        <i class="bi bi-sunrise fs-4"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold" id="sunriseVal">06:15</div>
                                        <small>Sunrise</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts (dynamic) -->
    <div class="row mb-4" id="alertsContainer">
        <!-- will be filled by JS -->
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Hourly Forecast -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Today's Forecast</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-success active" data-type="hourly">Hourly</button>
                        <button class="btn btn-sm btn-outline-success" data-type="daily">Daily</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Hourly forecast container -->
                    <div class="row g-3" id="hourlyForecast"></div>
                    <!-- Daily forecast container -->
                    <div class="d-none" id="dailyForecast"></div>
                </div>
            </div>

            <!-- Farming Recommendations (dynamic) -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Farming Recommendations</h5>
                </div>
                <div class="card-body" id="recommendationsContainer">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Weather Metrics (dynamic) -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Weather Metrics</h5>
                </div>
                <div class="card-body" id="metricsContainer">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Historical Data Chart -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Historical Rainfall</h5>
                </div>
                <div class="card-body">
                    <canvas id="rainfallChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Weather Alerts (dynamic) -->
            <div class="card border-warning" id="activeAlertsCard">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-bell-fill me-2"></i>Active Alerts</h5>
                </div>
                <div class="card-body" id="activeAlerts">
                    <!-- filled by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Interactive Weather Map -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Regional Weather Map</h5>
                </div>
                <div class="card-body">
                    <div id="weatherMap"></div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-success p-2 me-3">
                                    <i class="bi bi-sun-fill text-white"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Sunny Areas</h6>
                                    <small class="text-muted">Northern regions clear</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-info p-2 me-3">
                                    <i class="bi bi-cloud-rain-fill text-white"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Rainfall Areas</h6>
                                    <small class="text-muted">Southern regions experiencing rain</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-warning p-2 me-3">
                                    <i class="bi bi-cloud-lightning-rain-fill text-white"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Storm Areas</h6>
                                    <small class="text-muted">Coastal regions under watch</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location Modal (unchanged) -->
<div class="modal fade" id="locationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newLocation" class="form-label">Enter City or Region</label>
                    <input type="text" class="form-control" id="newLocation"
                           placeholder="e.g., Delhi, Punjab, Maharashtra">
                </div>
                <div class="mb-3">
                    <label class="form-label">Or Select from List</label>
                    <select class="form-select" id="locationSelect">
                        <option>Delhi</option>
                        <option>Punjab</option>
                        <option>Maharashtra</option>
                        <option>Karnataka</option>
                        <option>Tamil Nadu</option>
                        <option>Uttar Pradesh</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveLocation">Save Location</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet and Chart.js scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Toggle between hourly and daily forecast
    $('[data-type="hourly"]').click(function() {
        $(this).addClass('active');
        $('[data-type="daily"]').removeClass('active');
        $('#hourlyForecast').removeClass('d-none');
        $('#dailyForecast').addClass('d-none');
    });
    $('[data-type="daily"]').click(function() {
        $(this).addClass('active');
        $('[data-type="hourly"]').removeClass('active');
        $('#dailyForecast').removeClass('d-none');
        $('#hourlyForecast').addClass('d-none');
    });

    // Change location modal
    $('#changeLocation').click(function() {
        $('#locationModal').modal('show');
    });

    // Save location
    $('#saveLocation').click(function() {
        var newCity = $('#newLocation').val() || $('#locationSelect').val();
        if (!newCity) {
            alert('Please enter or select a city.');
            return;
        }
        $.ajax({
            url: '/update_location',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({city: newCity}),
            success: function(response) {
                if (response.success) {
                    $('#locationModal').modal('hide');
                    $('#cityName').text(newCity);
                    fetchWeatherData();
                } else {
                    alert('Error updating location: ' + response.error);
                }
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Server error'));
            }
        });
    });

    // Fetch weather data
    function fetchWeatherData() {
        $('#weatherSpinner').show();
        $.get('/api/weather', function(response) {
            $('#weatherSpinner').hide();
            if (response.success) {
                updateWeatherDisplay(response.weather);
                updateRainfallChart(); // static for now, but could be dynamic
            } else {
                console.error('Weather fetch failed:', response.error);
                $('#alertsContainer').html('<div class="alert alert-danger">Failed to load weather data.</div>');
            }
        }).fail(function() {
            $('#weatherSpinner').hide();
            console.error('Failed to connect to weather API.');
            $('#alertsContainer').html('<div class="alert alert-danger">Unable to reach weather service.</div>');
        });
    }

    // Helper: map OpenWeatherMap icon code to Bootstrap icon class
    function getBootstrapIcon(iconCode) {
        const mapping = {
            '01d': 'bi bi-sun-fill',
            '01n': 'bi bi-moon-fill',
            '02d': 'bi bi-cloud-sun-fill',
            '02n': 'bi bi-cloud-moon-fill',
            '03d': 'bi bi-cloud-fill',
            '03n': 'bi bi-cloud-fill',
            '04d': 'bi bi-clouds-fill',
            '04n': 'bi bi-clouds-fill',
            '09d': 'bi bi-cloud-rain-fill',
            '09n': 'bi bi-cloud-rain-fill',
            '10d': 'bi bi-cloud-rain-fill',
            '10n': 'bi bi-cloud-rain-fill',
            '11d': 'bi bi-cloud-lightning-fill',
            '11n': 'bi bi-cloud-lightning-fill',
            '13d': 'bi bi-cloud-snow-fill',
            '13n': 'bi bi-cloud-snow-fill',
            '50d': 'bi bi-cloud-fog-fill',
            '50n': 'bi bi-cloud-fog-fill'
        };
        return mapping[iconCode] || 'bi bi-cloud-sun-fill';
    }

    function getRecIcon(title) {
        const icons = {
            'Irrigation': 'droplet-fill',
            'Pest Alert': 'bug-fill',
            'Fertilizer': 'flower1',
            'Harvest': 'calendar-check'
        };
        return icons[title] || 'info-circle-fill';
    }

    function updateWeatherDisplay(data) {
        // Current weather
        $('#currentTemp').text(data.temperature + '°C');
        $('#feelsLike').text('Feels like ' + (data.feels_like || data.temperature) + '°C');
        $('#weatherDesc').text(data.conditions);
        $('#weatherIcon').attr('class', getBootstrapIcon(data.icon) + ' weather-icon');

        // Metrics in header
        $('#humidityVal').text(data.humidity + '%');
        $('#windVal').text(data.wind_speed);
        $('#sunriseVal').text(data.sunrise || '06:00');

        // Alerts banner
        let alertsHtml = '';
        if (data.alerts && data.alerts.length > 0) {
            data.alerts.forEach(alert => {
                alertsHtml += `
                <div class="col-12">
                    <div class="alert alert-warning d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                        <div><strong>Weather Alert:</strong> ${alert}</div>
                    </div>
                </div>`;
            });
        } else {
            alertsHtml = `
            <div class="col-12">
                <div class="alert alert-info d-flex align-items-center">
                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                    <div>No active weather alerts.</div>
                </div>
            </div>`;
        }
        $('#alertsContainer').html(alertsHtml);

        // Hourly forecast
        let hourlyHtml = '';
        if (data.hourly && data.hourly.length) {
            data.hourly.forEach(item => {
                hourlyHtml += `
                <div class="col-6 col-md-3 col-lg-2">
                    <div class="forecast-card text-center p-3">
                        <div class="fw-bold mb-2">${item.time}</div>
                        <i class="${getBootstrapIcon(item.icon)} weather-icon text-warning mb-2"></i>
                        <div class="fw-bold mb-1">${item.temp}°C</div>
                        <small class="text-muted d-block">${item.description}</small>
                        <small class="text-muted">${item.pop || 0}% rain</small>
                    </div>
                </div>`;
            });
        } else {
            hourlyHtml = '<p class="text-muted">No hourly data available.</p>';
        }
        $('#hourlyForecast').html(hourlyHtml);

        // Daily forecast
        let dailyHtml = '';
        if (data.daily && data.daily.length) {
            data.daily.forEach(item => {
                dailyHtml += `
                <div class="row align-items-center mb-3">
                    <div class="col-2">
                        <strong>${item.day}</strong>
                    </div>
                    <div class="col-3">
                        <i class="${getBootstrapIcon(item.icon)} me-2"></i>
                        <span>${item.description}</span>
                    </div>
                    <div class="col-4">
                        <div class="d-flex align-items-center">
                            <small class="me-2">${item.low}°</small>
                            <div class="progress flex-grow-1 rain-progress">
                                <div class="progress-bar bg-info" style="width: ${item.pop || 0}%"></div>
                            </div>
                            <small class="ms-2">${item.high}°</small>
                        </div>
                    </div>
                    <div class="col-3 text-end">
                        <span class="badge bg-info">${item.pop || 0}% rain</span>
                    </div>
                </div>`;
            });
        } else {
            dailyHtml = '<p class="text-muted">No daily data available.</p>';
        }
        $('#dailyForecast').html(dailyHtml);

        // Weather Metrics (right column)
        const rainProb = (data.hourly && data.hourly[0]) ? data.hourly[0].pop : 40;
        const metricsHtml = `
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>UV Index</span>
                    <span class="fw-bold">${data.uvi || 5} (${uviCategory(data.uvi || 5)})</span>
                </div>
                <div class="progress rain-progress">
                    <div class="progress-bar bg-warning" style="width: ${(data.uvi || 5) * 10}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>Rain Probability</span>
                    <span class="fw-bold">${rainProb}%</span>
                </div>
                <div class="progress rain-progress">
                    <div class="progress-bar bg-info" style="width: ${rainProb}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>Humidity</span>
                    <span class="fw-bold">${data.humidity}%</span>
                </div>
                <div class="progress rain-progress">
                    <div class="progress-bar bg-primary" style="width: ${data.humidity}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>Wind Speed</span>
                    <span class="fw-bold">${data.wind_speed}</span>
                </div>
                <div class="progress rain-progress">
                    <div class="progress-bar bg-success" style="width: ${parseFloat(data.wind_speed) * 3 || 30}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>Visibility</span>
                    <span class="fw-bold">${data.visibility || 10} km</span>
                </div>
                <div class="progress rain-progress">
                    <div class="progress-bar bg-secondary" style="width: ${(data.visibility || 10) * 10}%"></div>
                </div>
            </div>
        `;
        $('#metricsContainer').html(metricsHtml);

        // Farming Recommendations
        let recHtml = '<div class="row">';
        if (data.recommendations && data.recommendations.length) {
            data.recommendations.forEach(rec => {
                const [title, type, message] = rec;
                recHtml += `
                <div class="col-md-6 mb-3">
                    <div class="alert alert-${type}">
                        <h6><i class="bi bi-${getRecIcon(title)} me-2"></i>${title}</h6>
                        <p class="mb-0">${message}</p>
                    </div>
                </div>`;
            });
        } else {
            recHtml += '<p class="text-muted">No recommendations available.</p>';
        }
        recHtml += '</div>';
        $('#recommendationsContainer').html(recHtml);

        // Active Alerts (inside card)
        let activeAlertsHtml = '';
        if (data.alerts && data.alerts.length) {
            data.alerts.forEach(alert => {
                activeAlertsHtml += `<div class="alert alert-warning mb-2"><small><strong>Alert:</strong> ${alert}</small></div>`;
            });
        } else {
            activeAlertsHtml = '<p class="text-muted mb-0">No active alerts.</p>';
        }
        activeAlertsHtml += `
            <div class="mt-3">
                <button class="btn btn-sm btn-outline-warning w-100">
                    <i class="bi bi-bell me-2"></i>Set Custom Alerts
                </button>
            </div>
        `;
        $('#activeAlerts').html(activeAlertsHtml);

        // Initialize map (with default coordinates; can be enhanced with actual lat/lon from data)
        if (window.map) window.map.remove();
        window.map = L.map('weatherMap').setView([20.5937, 78.9629], 5); // India center
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
    }

    function uviCategory(uvi) {
        if (uvi <= 2) return 'Low';
        if (uvi <= 5) return 'Medium';
        if (uvi <= 7) return 'High';
        if (uvi <= 10) return 'Very High';
        return 'Extreme';
    }

    // Static historical rainfall chart (can be made dynamic if backend provides data)
    let rainfallChart;
    function updateRainfallChart() {
        const ctx = document.getElementById('rainfallChart').getContext('2d');
        if (rainfallChart) rainfallChart.destroy();
        rainfallChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['This Month', 'Last Month', 'Last Year'],
                datasets: [{
                    label: 'Rainfall (mm)',
                    data: [120, 80, 150],
                    backgroundColor: ['#0d6efd', '#0dcaf0', '#198754']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Auto-refresh every 15 minutes
    setInterval(fetchWeatherData, 900000);
    fetchWeatherData();   // initial load
});
</script>
{% endblock %}

