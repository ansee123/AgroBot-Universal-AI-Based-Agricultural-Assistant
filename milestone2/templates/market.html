{% extends "base.html" %}

{% block title %}Market Prices - AI-AgroBot{% endblock %}

{% block extra_css %}
<style>
/* ===== Enhanced Colorful Styles ===== */
.price-card {
    border-radius: 15px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
}
.price-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}
.price-change-up {
    color: #198754;
    font-weight: bold;
}
.price-change-down {
    color: #dc3545;
    font-weight: bold;
}
.crop-icon {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
}
.filter-chip {
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 8px 16px;
    border-radius: 20px;
    background-color: #e9ecef;
    color: #495057;
}
.filter-chip:hover {
    background-color: #dee2e6;
}
.filter-chip.active {
    background: linear-gradient(45deg, #198754, #20c997);
    color: white;
    box-shadow: 0 4px 10px rgba(25,135,84,0.3);
}
.market-table th {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    border-bottom: 2px solid #198754;
}
.table-hover tbody tr:hover {
    background-color: rgba(25,135,84,0.05);
}
.badge-demand {
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 500;
}
.badge-demand.high {
    background: #d1e7dd;
    color: #0a3622;
}
.badge-demand.medium {
    background: #fff3cd;
    color: #856404;
}
.badge-demand.low {
    background: #f8d7da;
    color: #721c24;
}
.news-item {
    border-left: 3px solid #198754;
    padding-left: 15px;
    margin-bottom: 20px;
}
.regional-market-item {
    border-bottom: 1px solid #e9ecef;
    padding: 12px 0;
}
.regional-market-item:last-child {
    border-bottom: none;
}
.status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}
.status-active {
    background: #d1e7dd;
    color: #0a3622;
}
.status-moderate {
    background: #fff3cd;
    color: #856404;
}
.recommendation-card {
    border-radius: 12px;
    border: none;
    background: linear-gradient(135deg, #fff, #f8f9fa);
}
.gradient-header {
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
    border-radius: 15px 15px 0 0;
    color: white;
}
</style>
<!-- ApexCharts CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.45.2/dist/apexcharts.css">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header with Gradient -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card gradient-header border-0">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="display-5 fw-bold mb-3">üåæ Market Intelligence</h1>
                            <p class="lead mb-4">Real-time prices, trends, and analysis for agricultural commodities</p>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-light text-dark"><i class="bi bi-clock me-1"></i>Updated: Just now</span>
                                <span class="badge bg-light text-dark"><i class="bi bi-shop me-1"></i>Source: APMC Markets</span>
                                <span class="badge bg-light text-dark"><i class="bi bi-geo-alt me-1"></i>Region: {{ current_user.region or 'National' }}</span>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="display-6 mb-2 text-white">‚Çπ 2,850</div>
                            <small class="text-white-50">Average Wheat Price per Quintal</small>
                            <div class="text-white mt-2"><i class="bi bi-arrow-up-short"></i> +2.5% Today</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats - Colorful Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card price-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">üèÜ Highest Price</h6>
                            <h4 class="mb-0">Cotton</h4>
                            <div class="price-change-up">‚Çπ6,500/quintal</div>
                        </div>
                        <div class="crop-icon" style="background: linear-gradient(135deg, #19875420, #19875440); color:#198754;">
                            <i class="bi bi-flower3 fs-3"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card price-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">üìä Most Volatile</h6>
                            <h4 class="mb-0">Soybean</h4>
                            <div class="price-change-down">-3.2% today</div>
                        </div>
                        <div class="crop-icon" style="background: linear-gradient(135deg, #ffc10720, #ffc10740); color:#ffc107;">
                            <i class="bi bi-tree fs-3"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card price-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">üí∞ Best Buy</h6>
                            <h4 class="mb-0">Corn</h4>
                            <div class="price-change-up">+1.8% this week</div>
                        </div>
                        <div class="crop-icon" style="background: linear-gradient(135deg, #0dcaf020, #0dcaf040); color:#0dcaf0;">
                            <i class="bi bi-egg-fried fs-3"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card price-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">üìà Demand Trend</h6>
                            <h4 class="mb-0">Rice</h4>
                            <div class="text-success">High demand</div>
                        </div>
                        <div class="crop-icon" style="background: linear-gradient(135deg, #0d6efd20, #0d6efd40); color:#0d6efd;">
                            <i class="bi bi-basket fs-3"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex flex-wrap gap-2">
                                <span class="filter-chip active" data-filter="all">All Crops</span>
                                <span class="filter-chip" data-filter="grains">Grains</span>
                                <span class="filter-chip" data-filter="pulses">Pulses</span>
                                <span class="filter-chip" data-filter="vegetables">Vegetables</span>
                                <span class="filter-chip" data-filter="fruits">Fruits</span>
                                <span class="filter-chip" data-filter="commercial">Commercial</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-success"></i></span>
                                <input type="text" class="form-control border-start-0" placeholder="Search crop or commodity..." id="marketSearch">
                                <button class="btn btn-success" type="button">Search</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Market Table -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom">
                    <h5 class="mb-0"><i class="bi bi-table me-2 text-success"></i>Current Market Prices</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-success active" data-sort="price">Price</button>
                        <button class="btn btn-sm btn-outline-success" data-sort="change">Change</button>
                        <button class="btn btn-sm btn-outline-success" data-sort="demand">Demand</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 market-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Crop/Commodity</th>
                                    <th>Market</th>
                                    <th>Min Price</th>
                                    <th>Max Price</th>
                                    <th>Avg Price</th>
                                    <th>Change</th>
                                    <th>Demand</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="marketTable">
                                <!-- Data populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Prices in ‚Çπ per quintal, updated every 15 minutes</small>
                        <button class="btn btn-sm btn-success">
                            <i class="bi bi-download me-2"></i>Export Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modern Price Chart with ApexCharts -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="bi bi-graph-up-arrow me-2 text-success"></i>Price Trends - Last 30 Days</h5>
                </div>
                <div class="card-body">
                    <div id="priceChart" style="height:300px; width:100%;"></div>
                    <div class="row mt-3 text-center">
                        <div class="col-md-4">
                            <div class="text-success">
                                <i class="bi bi-arrow-up-right-circle-fill fs-3"></i>
                                <div class="fw-bold">+12.5%</div>
                                <small>Monthly Trend</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-warning">
                                <i class="bi bi-graph-up-arrow fs-3"></i>
                                <div class="fw-bold">‚Çπ3,200</div>
                                <small>30-day High</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-info">
                                <i class="bi bi-graph-down-arrow fs-3"></i>
                                <div class="fw-bold">‚Çπ2,800</div>
                                <small>30-day Low</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Colorful Widgets -->
        <div class="col-lg-4">
            <!-- Your Crops -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="bi bi-tree me-2 text-success"></i>Your Crops</h5>
                </div>
                <div class="card-body">
                    {% if current_user.primary_crop %}
                    <div class="alert alert-success border-0" style="background: linear-gradient(135deg, #d1e7dd, #c3e6cb);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ current_user.primary_crop }}</h6>
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div class="fw-bold">‚Çπ3,200</div>
                                        <small>Current</small>
                                    </div>
                                    <div>
                                        <div class="price-change-up">+2.8%</div>
                                        <small>Today</small>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="d-block text-muted">Best Time to Sell</small>
                                <span class="badge bg-success px-3 py-2">Now</span>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="bi bi-tree display-4 text-success mb-3"></i>
                        <p class="text-muted">No crops added to your profile</p>
                        <a href="{{ url_for('profile') }}" class="btn btn-success px-4">Add Crops</a>
                    </div>
                    {% endif %}

                    <div class="mt-3">
                        <h6 class="text-muted">üîî Price Alert</h6>
                        <div class="input-group mb-2">
                            <input type="number" class="form-control" placeholder="Target price" value="3500">
                            <button class="btn btn-outline-success" type="button">Set</button>
                        </div>
                        <small class="text-muted">Get notified when price reaches target</small>
                    </div>
                </div>
            </div>

            <!-- Market News -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="bi bi-newspaper me-2 text-success"></i>Market News</h5>
                </div>
                <div class="card-body">
                    <div class="news-item">
                        <small class="text-success">2 hours ago</small>
                        <h6 class="mt-1">üåæ Wheat Exports Increase by 15%</h6>
                        <p class="small text-muted">India exports 2.5 million tonnes of wheat this month...</p>
                    </div>
                    <div class="news-item">
                        <small class="text-warning">5 hours ago</small>
                        <h6 class="mt-1">üìà Government Announces MSP Hike</h6>
                        <p class="small text-muted">Minimum Support Price increased for paddy and pulses...</p>
                    </div>
                    <div class="news-item">
                        <small class="text-info">1 day ago</small>
                        <h6 class="mt-1">‚òî Monsoon Impact on Prices</h6>
                        <p class="small text-muted">Delayed monsoon affects crop sowing in northern regions...</p>
                    </div>
                    <a href="#" class="btn btn-outline-success w-100 mt-2">View All News <i class="bi bi-arrow-right ms-1"></i></a>
                </div>
            </div>

            <!-- Regional Markets -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2 text-success"></i>Regional Markets</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item px-3 py-3 regional-market-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Delhi Mandi</h6>
                                    <small class="text-muted">Highest prices for vegetables</small>
                                </div>
                                <span class="status-badge status-active">Active</span>
                            </div>
                        </div>
                        <div class="list-group-item px-3 py-3 regional-market-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Punjab APMC</h6>
                                    <small class="text-muted">Wheat procurement center</small>
                                </div>
                                <span class="status-badge status-active">Active</span>
                            </div>
                        </div>
                        <div class="list-group-item px-3 py-3 regional-market-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Maharashtra</h6>
                                    <small class="text-muted">Cotton trading hub</small>
                                </div>
                                <span class="status-badge status-moderate">Moderate</span>
                            </div>
                        </div>
                        <div class="list-group-item px-3 py-3 regional-market-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Karnataka</h6>
                                    <small class="text-muted">Coffee and spices</small>
                                </div>
                                <span class="status-badge status-active">Active</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-3">
                        <button class="btn btn-outline-success w-100">
                            <i class="bi bi-map me-2"></i>View All Markets
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Recommendations - Colorful Alerts -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header gradient-header text-white">
                    <h5 class="mb-0"><i class="bi bi-lightbulb-fill me-2"></i>AI Recommendations</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="alert alert-info border-0 d-flex align-items-center" role="alert" style="background: linear-gradient(135deg, #cff4fc, #b6effb);">
                                <i class="bi bi-arrow-up-circle-fill fs-3 me-3 text-info"></i>
                                <div>
                                    <h6 class="alert-heading">Best to Sell Now</h6>
                                    <p class="mb-0">Wheat, Cotton, Soybean</p>
                                    <small>Prices at 3-month high</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="alert alert-warning border-0 d-flex align-items-center" role="alert" style="background: linear-gradient(135deg, #fff3cd, #ffe69c);">
                                <i class="bi bi-arrow-down-circle-fill fs-3 me-3 text-warning"></i>
                                <div>
                                    <h6 class="alert-heading">Wait for Better Price</h6>
                                    <p class="mb-0">Rice, Corn, Pulses</p>
                                    <small>Prices expected to rise next week</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="alert alert-success border-0 d-flex align-items-center" role="alert" style="background: linear-gradient(135deg, #d1e7dd, #b8e0ce);">
                                <i class="bi bi-cart-plus-fill fs-3 me-3 text-success"></i>
                                <div>
                                    <h6 class="alert-heading">Good to Buy</h6>
                                    <p class="mb-0">Fertilizers, Seeds</p>
                                    <small>Input costs at seasonal low</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3 p-3 bg-light rounded">
                        <h6 class="text-success"><i class="bi bi-pie-chart-fill me-2"></i>Detailed Analysis for {{ current_user.primary_crop or 'Your Crops' }}</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Market demand is increasing by 2.5% weekly</li>
                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Export opportunities available through government schemes</li>
                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Consider selling in bulk to aggregators for better prices</li>
                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Storage costs may increase next month</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Price Details Modal -->
<div class="modal fade" id="priceModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="cropName"><i class="bi bi-info-circle me-2"></i>Crop Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="priceDetails">
                <!-- Details loaded via JS -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.2/dist/apexcharts.min.js"></script>
<script>
$(document).ready(function() {
    let marketData = [];
    let chart;

    // ========== RICH MOCK DATA (Vegetables & Fruits) ==========
    const mockMarketData = [
        // Grains
        { crop: "Wheat", category: "grains", market: "Punjab APMC", min: 2150, max: 2350, avg: 2250, change: "+2.5", demand: "High" },
        { crop: "Rice", category: "grains", market: "Haryana APMC", min: 2800, max: 3100, avg: 2950, change: "+1.2", demand: "High" },
        { crop: "Corn", category: "grains", market: "UP Mandi", min: 1800, max: 2000, avg: 1900, change: "+1.8", demand: "Medium" },
        { crop: "Barley", category: "grains", market: "Rajasthan", min: 1600, max: 1750, avg: 1675, change: "-0.5", demand: "Low" },
        // Pulses
        { crop: "Chickpea", category: "pulses", market: "MP Mandi", min: 5200, max: 5500, avg: 5350, change: "+3.1", demand: "High" },
        { crop: "Pigeon Pea", category: "pulses", market: "Maharashtra", min: 6100, max: 6450, avg: 6275, change: "+2.3", demand: "Medium" },
        { crop: "Green Gram", category: "pulses", market: "TN Market", min: 7200, max: 7500, avg: 7350, change: "+1.5", demand: "Medium" },
        { crop: "Black Gram", category: "pulses", market: "APMC", min: 5800, max: 6100, avg: 5950, change: "-0.8", demand: "Low" },
        // Vegetables
        { crop: "Potato", category: "vegetables", market: "UP Mandi", min: 1200, max: 1400, avg: 1300, change: "-1.2", demand: "Medium" },
        { crop: "Onion", category: "vegetables", market: "Maharashtra", min: 1800, max: 2200, avg: 2000, change: "+4.5", demand: "High" },
        { crop: "Tomato", category: "vegetables", market: "Karnataka", min: 1500, max: 1800, avg: 1650, change: "+3.2", demand: "High" },
        { crop: "Cauliflower", category: "vegetables", market: "Punjab", min: 2200, max: 2500, avg: 2350, change: "+0.9", demand: "Medium" },
        { crop: "Cabbage", category: "vegetables", market: "Haryana", min: 1100, max: 1300, avg: 1200, change: "-0.3", demand: "Low" },
        { crop: "Brinjal", category: "vegetables", market: "Gujarat", min: 800, max: 1000, avg: 900, change: "+1.1", demand: "Medium" },
        { crop: "Carrot", category: "vegetables", market: "HP Mandi", min: 2500, max: 2800, avg: 2650, change: "+2.0", demand: "High" },
        { crop: "Spinach", category: "vegetables", market: "UP", min: 600, max: 800, avg: 700, change: "-1.5", demand: "Low" },
        { crop: "Capsicum", category: "vegetables", market: "Maharashtra", min: 3200, max: 3500, avg: 3350, change: "+2.7", demand: "High" },
        // Fruits
        { crop: "Banana", category: "fruits", market: "TN Market", min: 3500, max: 3800, avg: 3650, change: "+1.8", demand: "High" },
        { crop: "Mango", category: "fruits", market: "APMC", min: 8000, max: 12000, avg: 10000, change: "+5.2", demand: "High" },
        { crop: "Apple", category: "fruits", market: "HP Mandi", min: 9000, max: 14000, avg: 11500, change: "+3.4", demand: "High" },
        { crop: "Orange", category: "fruits", market: "Nagpur", min: 4500, max: 5200, avg: 4850, change: "+2.1", demand: "Medium" },
        { crop: "Grapes", category: "fruits", market: "Nashik", min: 6000, max: 7500, avg: 6750, change: "-0.7", demand: "Low" },
        { crop: "Pomegranate", category: "fruits", market: "Maharashtra", min: 7000, max: 8500, avg: 7750, change: "+3.8", demand: "High" },
        { crop: "Papaya", category: "fruits", market: "APMC", min: 2800, max: 3200, avg: 3000, change: "+0.5", demand: "Medium" },
        { crop: "Watermelon", category: "fruits", market: "UP Mandi", min: 1500, max: 1800, avg: 1650, change: "-1.0", demand: "Low" },
        // Commercial crops
        { crop: "Cotton", category: "commercial", market: "Maharashtra", min: 6200, max: 6800, avg: 6500, change: "+2.9", demand: "High" },
        { crop: "Sugarcane", category: "commercial", market: "UP", min: 3500, max: 3800, avg: 3650, change: "+1.3", demand: "Medium" },
        { crop: "Soybean", category: "commercial", market: "MP Mandi", min: 4300, max: 4700, avg: 4500, change: "-3.2", demand: "Low" },
        { crop: "Groundnut", category: "commercial", market: "Gujarat", min: 5500, max: 5900, avg: 5700, change: "+2.0", demand: "High" }
    ];

    // Helper to get icon based on category
    function getCropIcon(category) {
        const icons = {
            grains: 'bi bi-flower1',
            pulses: 'bi bi-flower3',
            vegetables: 'bi bi-egg-fried',
            fruits: 'bi bi-tree',
            commercial: 'bi bi-basket'
        };
        return icons[category] || 'bi bi-tree';
    }

    // Show loading
    function showLoading() {
        $('#marketTable').html('<tr><td colspan="8" class="text-center py-4"><div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Fetching latest market prices...</p></td></tr>');
    }

    // Fetch market data from API with fallback to mock
    function fetchMarketData() {
        showLoading();
        $.ajax({
            url: '/api/market-prices',
            method: 'GET',
            dataType: 'json',
            timeout: 10000,
            success: function(response) {
                if (response.success && response.prices && response.prices.length) {
                    marketData = response.prices;
                    updateQuickStats(response.stats);
                } else {
                    console.warn('API returned no data, using mock data');
                    marketData = mockMarketData;
                    updateQuickStatsFromMock();
                }
                updateMarketTable(marketData);
                updateChartFromMock(); // or from response.trends if available
                updateLastUpdated(new Date().toISOString());
            },
            error: function(xhr, status, error) {
                console.error('API Error, using mock data:', error);
                marketData = mockMarketData;
                updateQuickStatsFromMock();
                updateMarketTable(marketData);
                updateChartFromMock();
                updateLastUpdated(new Date().toISOString());
                showError('Using offline data. Real-time updates unavailable.');
            }
        });
    }

    // Generate stats from mock data
    function updateQuickStatsFromMock() {
        const stats = {
            highest_price: { crop: "Mango", price: 10000 },
            most_volatile: { crop: "Soybean", change: "-3.2" },
            best_buy: { crop: "Corn", change: "1.8" },
            demand_trend: { crop: "Rice", demand: "High" }
        };
        $('.col-md-3 .price-card').eq(0).find('h4').text(stats.highest_price.crop);
        $('.col-md-3 .price-card').eq(0).find('.price-change-up').text('‚Çπ' + stats.highest_price.price + '/quintal');

        $('.col-md-3 .price-card').eq(1).find('h4').text(stats.most_volatile.crop);
        $('.col-md-3 .price-card').eq(1).find('.price-change-down').text(stats.most_volatile.change + '% today');

        $('.col-md-3 .price-card').eq(2).find('h4').text(stats.best_buy.crop);
        $('.col-md-3 .price-card').eq(2).find('.price-change-up').text('+' + stats.best_buy.change + '% this week');

        $('.col-md-3 .price-card').eq(3).find('h4').text(stats.demand_trend.crop);
        $('.col-md-3 .price-card').eq(3).find('.text-success').text(stats.demand_trend.demand + ' demand');
    }

    // Render market table with icons
    function updateMarketTable(data) {
        const table = $('#marketTable');
        table.empty();

        data.forEach(item => {
            const changeClass = parseFloat(item.change) >= 0 ? 'price-change-up' : 'price-change-down';
            const demandClass = item.demand === 'High' ? 'badge-demand high' : item.demand === 'Medium' ? 'badge-demand medium' : 'badge-demand low';
            const iconClass = getCropIcon(item.category);

            const row = `
                <tr data-crop="${item.crop.toLowerCase()}">
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="crop-icon bg-success bg-opacity-10 text-success me-3">
                                <i class="${iconClass}"></i>
                            </div>
                            <div>
                                <strong>${item.crop}</strong><br>
                                <small class="text-muted">${item.category.charAt(0).toUpperCase() + item.category.slice(1)}</small>
                            </div>
                        </div>
                    </td>
                    <td>${item.market}</td>
                    <td>‚Çπ${item.min}</td>
                    <td>‚Çπ${item.max}</td>
                    <td><strong>‚Çπ${item.avg}</strong></td>
                    <td class="${changeClass}">${item.change}%</td>
                    <td><span class="${demandClass}">${item.demand}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-success view-details" data-crop="${item.crop}">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
            table.append(row);
        });
    }

    // Mock chart data (30-day trend for a few crops)
    function updateChartFromMock() {
        const options = {
            series: [{
                name: 'Wheat',
                data: [2250, 2280, 2310, 2290, 2320, 2350, 2380, 2400, 2390, 2410, 2430, 2450, 2440, 2460, 2480, 2500, 2520, 2510, 2530, 2550, 2570, 2590, 2580, 2600, 2620, 2650, 2670, 2690, 2710, 2730]
            }, {
                name: 'Tomato',
                data: [1500, 1520, 1550, 1580, 1600, 1620, 1650, 1680, 1700, 1720, 1750, 1780, 1800, 1820, 1850, 1880, 1900, 1920, 1950, 1980, 2000, 2020, 2050, 2080, 2100, 2120, 2150, 2180, 2200, 2220]
            }, {
                name: 'Mango',
                data: [8000, 8200, 8500, 8800, 9000, 9200, 9500, 9800, 10000, 10200, 10500, 10800, 11000, 11200, 11500, 11800, 12000, 11800, 11600, 11400, 11200, 11000, 10800, 10600, 10400, 10200, 10000, 9800, 9600, 9400]
            }],
            chart: {
                type: 'line',
                height: 300,
                toolbar: { show: false },
                zoom: { enabled: false },
                background: 'transparent'
            },
            colors: ['#198754', '#ffc107', '#dc3545'],
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 2 },
            xaxis: {
                categories: Array.from({length: 30}, (_, i) => `D${i+1}`),
                labels: { show: false }
            },
            yaxis: {
                labels: { formatter: (val) => `‚Çπ${val}` }
            },
            legend: { position: 'top' }
        };
        if (chart) chart.destroy();
        chart = new ApexCharts(document.querySelector("#priceChart"), options);
        chart.render();
    }

    function updateQuickStats(stats) { /* same as before but with mock fallback */ }
    function updateLastUpdated(timestamp) { /* same */ }
    function showError(message) { /* same */ }

    // Filter, sort, search (same as before, but ensure filter chips match categories)
    $('.filter-chip').click(function() {
        $('.filter-chip').removeClass('active');
        $(this).addClass('active');
        const filter = $(this).data('filter');
        let filteredData = marketData;
        if (filter !== 'all') {
            filteredData = marketData.filter(item => item.category === filter);
        }
        updateMarketTable(filteredData);
    });

    $('[data-sort]').click(function() { /* same */ });
    $('#marketSearch').on('input', function() { /* same */ });

    // View details modal (enhanced with more info)
    $(document).on('click', '.view-details', function() {
        const cropName = $(this).data('crop');
        const crop = marketData.find(c => c.crop === cropName);
        if (!crop) return;

        $('#cropName').text(`${cropName} Market Details`);
        $('#priceDetails').html(`
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-0 bg-light mb-3">
                        <div class="card-body">
                            <h6 class="text-success"><i class="bi bi-bar-chart-steps me-2"></i>Price Statistics</h6>
                            <div class="mb-2">
                                <small class="text-muted">Current Price</small>
                                <div class="h4">‚Çπ${crop.avg}</div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Min Price</small>
                                    <div class="fw-bold">‚Çπ${crop.min}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Max Price</small>
                                    <div class="fw-bold">‚Çπ${crop.max}</div>
                                </div>
                            </div>
                            <hr>
                            <div class="mb-2">
                                <small class="text-muted">Weekly Trend</small>
                                <div class="fw-bold ${parseFloat(crop.change) >= 0 ? 'text-success' : 'text-danger'}">${crop.change}%</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 bg-light mb-3">
                        <div class="card-body">
                            <h6 class="text-success"><i class="bi bi-shop me-2"></i>Market Info</h6>
                            <div class="mb-2">
                                <small class="text-muted">Primary Market</small>
                                <div class="fw-bold">${crop.market}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Demand Level</small>
                                <div class="fw-bold ${crop.demand === 'High' ? 'text-success' : crop.demand === 'Medium' ? 'text-warning' : 'text-danger'}">${crop.demand}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Arrivals (Tonnes)</small>
                                <div class="fw-bold">${Math.floor(Math.random() * 500 + 100)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert alert-info border-0 d-flex align-items-center" role="alert">
                <i class="bi bi-lightbulb fs-3 me-3"></i>
                <div>
                    <h6 class="alert-heading">AI Recommendation</h6>
                    <p class="mb-0">${parseFloat(crop.change) >= 0 ? 'üìà Prices are rising. Consider selling now for maximum profit.' : 'üìâ Prices are declining. Consider waiting for better prices or selling in smaller quantities.'}</p>
                    <small class="d-block mt-1">Based on 30-day historical trend and market demand.</small>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-success px-4"><i class="bi bi-bell me-2"></i>Set Price Alert</button>
                <button class="btn btn-outline-success ms-2 px-4"><i class="bi bi-calendar-week me-2"></i>Historical Data</button>
            </div>
        `);
        $('#priceModal').modal('show');
    });

    // Initial fetch
    fetchMarketData();

    // Auto-refresh every 5 minutes
    setInterval(fetchMarketData, 300000);
});
</script>
{% endblock %}

